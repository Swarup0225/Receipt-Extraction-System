<!DOCTYPE html>
<html>
<head>
    <title>Receipt Extractor</title>
</head>
<body>
    <h2>Receipt Extractor</h2>
    
    <div id="authSection">
        <input type="email" id="useremail" placeholder="Email">
        <input type="password" id="userPassword" placeholder="Password">
        <button id="btnSignUp">Sign Up</button>
        <button id="btnSignIn">Login</button>
    </div>

    <div id="mainsection" style="display:none;">
        <button id="btnLogout" style="float: right;">Logout</button> <textarea id="receiptText" rows="10" cols="50" placeholder="Paste receipt text here..."></textarea> 
        <br>
        <button id="btnSubmit">Extract Data</button>
        <pre id="result" style="background: #f4f4f4; padding: 10px; margin-top: 10px;"></pre> 
    </div>

    

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAxzwSR_pJjeuDom_2CMAeBzhodrjQ_pRs",
            authDomain: "receipt-extraction-b61df.firebaseapp.com",
            projectId: "receipt-extraction-b61df",
            storageBucket: "receipt-extraction-b61df.firebasestorage.app",
            messagingSenderId: "183086125860",
            appId: "1:183086125860:web:90bfefb79c4eea933759b1"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        window.auth = auth; 

        const authSection = document.getElementById("authSection");
        const mainsection = document.getElementById("mainsection");
        const useremail = document.getElementById("useremail");
        const userPassword = document.getElementById("userPassword");

        document.getElementById("btnSignUp").addEventListener("click", async () => {
            try {
                await createUserWithEmailAndPassword(auth, useremail.value, userPassword.value);
                alert("User Signed up Successfully");
            } catch (error) {
                alert(error.message);
            }
        });

        document.getElementById("btnSignIn").addEventListener("click", async () => {
            try {
                await signInWithEmailAndPassword(auth, useremail.value, userPassword.value);
                alert("User Signed in Successfully");
            } catch (error) {
                alert(error.message);
            }
        });
         document.getElementById("btnLogout").addEventListener("click", async () => {
            try {
               await auth.signOut();
               alert("Logged out successfully!");
               
            } catch (error) {
               alert("Logout failed: " + error.message);
            }
         });

        const submitReceipt = async () => {
            const text = document.getElementById("receiptText").value;
            const resultPre = document.getElementById("result");
            resultPre.textContent = "Processing... Please wait.";

            try {
                
                const token = await auth.currentUser.getIdToken();

              
                const response = await fetch('http://127.0.0.1:8000/extract', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ "receipt_text": text })
                });

                if (response.ok) {
                    const data = await response.json();
                    resultPre.textContent = JSON.stringify(data, null, 2);
                } else {
                    const errData = await response.json();
                    resultPre.textContent = "Error: " + (errData.detail || response.status);
                }
            } catch (error) {
                resultPre.textContent = "Request failed: " + error.message;
            }
        };

        document.getElementById("btnSubmit").addEventListener('click', submitReceipt);

        onAuthStateChanged(auth, (user) => {
            if (user) {
                authSection.style.display = "none";
                mainsection.style.display = "block";
            } else {
                authSection.style.display = "block";
                mainsection.style.display = "none";
            }
        });
    </script>
</body>
</html>